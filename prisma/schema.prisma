generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ MODELOS DE USUARIOS Y AUTENTICACIÓN ============

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  phone     String?
  role      Role       @default(TECNICO)
  status    UserStatus @default(ACTIVE)
  password  String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relaciones
  assignedEquipments Equipment[]
  payrollRecords     PayrollRecord[]
  advances          Advance[]

  @@map("users")
}

enum Role {
  ADMINISTRADOR
  TECNICO
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

// ============ MODELOS DE EQUIPOS ============

model Customer {
  id        String      @id @default(cuid())
  name      String
  phone     String
  ruc       String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relaciones
  equipments Equipment[]

  @@map("customers")

  // Indices
  @@index([name], name: "customer_name_idx")
  @@index([phone], name: "customer_phone_idx")
}

model Equipment {
  id           String          @id @default(cuid())
  code         String          @unique // RJD-YMD-NNNN
  type         EquipmentType
  brand        String?
  model        String?
  serialNumber String?
  reportedFlaw String
  accessories  String?
  serviceType  String?
  others       String?         // Contraseñas, indicaciones adicionales, etc.
  status       EquipmentStatus @default(RECEIVED)
  entryDate    DateTime        @default(now())
  deliveryDate DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relaciones
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  
  assignedTechnicianId String?
  assignedTechnician   User?   @relation(fields: [assignedTechnicianId], references: [id])

  statusHistory EquipmentStatusHistory[]
  payments      Payment[]

  @@map("equipments")

  // Indices
  @@index([status, entryDate(sort: Desc)], name: "equipment_status_date_idx")
  @@index([customerId], name: "equipment_customer_idx") 
  @@index([assignedTechnicianId], name: "equipment_technician_idx")
  @@index([status], name: "equipment_status_idx")
  @@index([entryDate(sort: Desc)], name: "equipment_date_idx")
  @@index([code], name: "equipment_code_idx")
}

model EquipmentStatusHistory {
  id          String          @id @default(cuid())
  equipmentId String
  equipment   Equipment       @relation(fields: [equipmentId], references: [id])
  status      EquipmentStatus
  observations String?
  changedBy   String          // User ID quien hizo el cambio
  changedAt   DateTime        @default(now())

  @@map("equipment_status_history")

  // Indices
  @@index([equipmentId, changedAt(sort: Desc)], name: "history_equipment_date_idx")
  @@index([changedAt(sort: Desc)], name: "history_date_idx")
}

enum EquipmentType {
  PC
  LAPTOP
  PRINTER
  PLOTTER
  OTHER
}

enum EquipmentStatus {
  RECEIVED    // Recibido
  REPAIR      // Reparación
  REPAIRED    // Reparado
  DELIVERED   // Entregado
  CANCELLED   // Cancelado
}

// ============ MODELOS FINANCIEROS ============

model Payment {
  id               String        @id @default(cuid())
  equipmentId      String
  equipment        Equipment     @relation(fields: [equipmentId], references: [id])
  totalAmount      Float
  advanceAmount    Float         @default(0)
  remainingAmount  Float
  paymentDate      DateTime      @default(now())
  paymentMethod    PaymentMethod
  voucherType      VoucherType
  paymentStatus    PaymentStatus @default(PENDING)
  beneficiary      String?       // Receptor del pago (generalmente "RJD")
  observations     String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("payments")

  // Indices
  @@index([equipmentId], name: "payment_equipment_idx")
  @@index([paymentDate(sort: Desc)], name: "payment_date_idx") 
  @@index([paymentStatus], name: "payment_status_idx")
  @@index([paymentDate, paymentStatus], name: "payment_date_status_idx")
}

enum PaymentMethod {
  CASH        // Efectivo
  YAPE
  PLIN
  TRANSFER    // Transferencia
}

enum VoucherType {
  RECEIPT     // Boleta
  INVOICE     // Factura
  DELIVERY_NOTE // Nota de entrega
}

enum PaymentStatus {
  PENDING     // Pendiente
  PARTIAL     // Pagado parcial
  COMPLETED   // Pagado total
}

model Expense {
  id            String        @id @default(cuid())
  type          ExpenseType
  description   String
  amount        Float
  beneficiary   String?       // Para pagos a trabajadores
  paymentMethod PaymentMethod
  expenseDate   DateTime      @default(now())
  observations  String?
  createdBy     String        // User ID quien creó el gasto
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("expenses")

  // Indices
  @@index([expenseDate(sort: Desc)], name: "expense_date_idx")
  @@index([type], name: "expense_type_idx")
  @@index([beneficiary], name: "expense_beneficiary_idx") 
  @@index([type, expenseDate], name: "expense_type_date_idx")
}

enum ExpenseType {
  ADVANCE      // Adelanto a trabajador
  SALARY       // Pago de salario
  SUPPLIES     // Materiales/insumos
  RENT         // Alquiler
  SERVICES     // Pago servicios (luz, agua, internet)
  FOOD         // Pago comida
  FUEL         // Pago combustible
  MAINTENANCE  // Mantenimiento
  OTHER        // Otros gastos
}

// ============ MODELOS DE PERSONAL ============

model PayrollRecord {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  amount     Float
  weekStart  DateTime // Inicio de semana
  weekEnd    DateTime // Fin de semana
  payDate    DateTime @default(now())
  observations String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("payroll_records")
}

model Advance {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  amount      Float
  reason      String?
  status      AdvanceStatus @default(PENDING)
  requestDate DateTime      @default(now())
  paidDate    DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("advances")
}

enum AdvanceStatus {
  PENDING     // Pendiente
  PAID        // Pagado
  CANCELLED   // Cancelado
}